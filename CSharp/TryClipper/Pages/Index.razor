@page "/{TestId:int}"

<PageTitle>Clipper2 Test Explorer</PageTitle>

<MudText Typo="Typo.h5" GutterBottom="true">Clipper2 Test Explorer</MudText>
<MudText Typo="Typo.h6">Test @TestId</MudText>

<MudToolBar>
    <MudText Class="ma-2">Caption: @caption</MudText>
    <MudSwitch Class="ma-2" T="bool" Label="Display Solution Coords" CheckedChanged="OnCheckedChanged" Checked="@displaySolutionCoords" />
    <MudText Typo="Typo.subtitle2">Elapsed: @elapsedMilliseconds ms</MudText>

    <MudSpacer />

    <MudSelect T="FillRule" Value="fillrule" ValueChanged="OnFillRuleChanged" Label="Fill Rule" Class="mx-2">
        <MudSelectItem Value="FillRule.EvenOdd" />
        <MudSelectItem Value="FillRule.Negative" />
        <MudSelectItem Value="FillRule.NonZero" />
        <MudSelectItem Value="FillRule.Positive" />
    </MudSelect>

    <MudSelect T="ClipType" Value="clipType" ValueChanged="OnClipTypeChanged" Label="Clip Type" Class="mx-2">
        <MudSelectItem Value="ClipType.None" />
        <MudSelectItem Value="ClipType.Union" />
        <MudSelectItem Value="ClipType.Intersection" />
        <MudSelectItem Value="ClipType.Difference" />
        <MudSelectItem Value="ClipType.Xor" />
    </MudSelect>
</MudToolBar>

@if (clipperA is not null)
{
    @((MarkupString)clipperA)
}

@if (clipperB is not null)
{
    @((MarkupString)clipperB)
}

@code {
    [Parameter] public int TestId { get; set; }

    Paths64 subj = new();
    Paths64 subj_open = new();
    Paths64 clip = new();
    Paths64 sol = new();
    Paths64 sol_open = new();
    long area2;
    string caption = "";
    ClipType clipType;
    FillRule fillrule;
    bool displaySolutionCoords = false;

    const int margin = 20;
    const int displayWidth = 800;
    const int displayHeight = 600;
    string clipperA, clipperB;

    long elapsedMilliseconds;

    protected override void OnParametersSet()
    {
        LoadData();

        Process();
    }

    void LoadData()
    {
        if (!ClipperFileIO.LoadTestNum(@"..\..\Tests\Tests.txt", TestId, subj, subj_open, clip, out clipType, out fillrule, out area2, out caption))
            return;
    }

    void Process()
    {
        var sw = System.Diagnostics.Stopwatch.StartNew();

        Clipper c3 = new();
        c3.AddPaths(subj, PathType.Subject);
        c3.AddPaths(subj_open, PathType.Subject, true);
        c3.AddPaths(clip, PathType.Clip);

        c3.Execute(clipType, fillrule, sol, sol_open);

        sw.Stop();
        elapsedMilliseconds = sw.ElapsedMilliseconds;

        clipperA = CreateDisplaySvg(caption, subj, subj_open, clip, null, null, fillrule, displaySolutionCoords);
        clipperB = CreateDisplaySvg(caption, subj, subj_open, clip, sol, sol_open, fillrule, displaySolutionCoords);
    }

    public static string CreateDisplaySvg(string caption, Paths64 subj, Paths64 subj_open, Paths64 clip, Paths64 sol, Paths64 sol_open, FillRule fillrule, bool displaySolutionCoords)
    {
        SimpleClipperSvgWriter svg = new(fillrule);
        if (caption != "")
            svg.AddText(caption, margin, margin, 14, SimpleClipperSvgWriter.navy);
        if (subj != null)
            svg.AddPaths(subj, false, 0x110066FF, 0x33000099, 0.8);
        if (subj_open != null)
            svg.AddPaths(subj_open, true, 0, 0x66AA0000, 1.2);
        if (clip != null)
            svg.AddPaths(clip, false, 0x11996600, 0x55993300, 0.8);
        if (sol != null)
            svg.AddPaths(sol, false, 0x4000FF00, 0x80000000, 1.2, displaySolutionCoords && sol.Count < 100);
        if (sol_open != null)
            svg.AddPaths(sol_open, true, 0, 0xFF00AAAA, 3.0);
        return svg.SaveToString(displayWidth, displayHeight, margin);
    }

    void OnCheckedChanged(bool newDisplay)
    {
        displaySolutionCoords = newDisplay;

        Process();

        StateHasChanged();
    }

    void OnFillRuleChanged(FillRule newFillRule)
    {
        fillrule = newFillRule;

        Process();

        StateHasChanged();
    }

    void OnClipTypeChanged(ClipType newClipType)
    {
        clipType = newClipType;

        Process();

        StateHasChanged();
    }
}
